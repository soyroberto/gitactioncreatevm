name: Create Windows 11 VMX
on:
  workflow_dispatch:
    inputs:
      sourceRdpIP:
        description: 'Your Public IP'
        required: true
        default: '*'
      vmSize:
        description: 'VM Size'
        required: false
        default: 'Standard_D4s_v3'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        run: |
          # Ensure Azure CLI is available
          az version || echo "Azure CLI already installed"

      - name: Azure Login with Service Principal
        run: |
          echo "Logging in with Service Principal..."
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          
          echo "Setting subscription..."
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          
          echo "âœ… Login successful!"
          az account show --query "{Subscription:name}" -o table

      - name: Check Resource Group
        run: |
          echo "Checking resource group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
          if az group exists --name "${{ secrets.AZURE_RESOURCE_GROUP }}"; then
            echo "âœ… Resource group exists"
          else
            echo "Creating resource group..."
            az group create \
              --name "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --location "${{ secrets.AZURE_LOCATION }}" \
              --tags "CreatedBy=GitHub" "Repo=${{ github.repository }}"
          fi

      - name: Check VNet Exists
        run: |
          echo "Checking VNet: ${{ secrets.AZURE_VNET_NAME }}"
          VNET_EXISTS=$(az network vnet list \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --query "[?name=='${{ secrets.AZURE_VNET_NAME }}'] | length(@)")
          
          if [ "$VNET_EXISTS" -eq 1 ]; then
            echo "âœ… VNet exists"
          else
            echo "âŒ VNet not found. Please create it first:"
            echo "az network vnet create \\"
            echo "  --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \\"
            echo "  --name ${{ secrets.AZURE_VNET_NAME }} \\"
            echo "  --address-prefix 10.0.0.0/16 \\"
            echo "  --subnet-name ${{ secrets.AZURE_SUBNET_NAME }} \\"
            echo "  --subnet-prefix 10.0.0.0/24 \\"
            echo "  --location ${{ secrets.AZURE_LOCATION }}"
            exit 1
          fi

      - name: Deploy VM with Bicep
        run: |
          echo "ðŸš€ Deploying Windows 11 VM..."
          
          # Create parameters file dynamically
          cat > /tmp/vm-params.json << EOF
          {
            "vmName": { "value": "${{ secrets.AZURE_VM_NAME }}" },
            "location": { "value": "${{ secrets.AZURE_LOCATION }}" },
            "adminUsername": { "value": "${{ secrets.AZURE_ADMIN_USERNAME }}" },
            "adminPassword": { "value": "${{ secrets.AZURE_ADMIN_PASSWORD }}" },
            "dnsName": { "value": "${{ secrets.AZURE_DNS_NAME }}" },
            "existingVnetName": { "value": "${{ secrets.AZURE_VNET_NAME }}" },
            "existingSubnetName": { "value": "${{ secrets.AZURE_SUBNET_NAME }}" },
            "sourceRdpIP": { "value": "${{ github.event.inputs.sourceRdpIP }}" },
            "vmSize": { "value": "${{ github.event.inputs.vmSize }}" }
          }
          EOF
          
          echo "Deployment parameters:"
          cat /tmp/vm-params.json
          
          # Deploy the VM
          az deployment group create \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --template-file ./infra/win11-vm.bicep \
            --parameters @/tmp/vm-params.json \
            --name "win11-deploy-${{ github.run_number }}"

      - name: Wait for VM
        run: |
          echo "â³ Waiting for VM to be ready..."
          az vm wait \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}" \
            --created \
            --timeout 600
          echo "âœ… VM is ready!"

      - name: Get Connection Info
        id: get-connection
        run: |
          # Get FQDN
          FQDN=$(az network public-ip show \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}-pip" \
            --query dnsSettings.fqdn -o tsv 2>/dev/null || echo "")
          
          if [ -n "$FQDN" ]; then
            echo "FQDN=$FQDN" >> $GITHUB_OUTPUT
            echo "âœ… Connection Details:"
            echo "   DNS: $FQDN"
            echo "   User: ${{ secrets.AZURE_ADMIN_USERNAME }}"
            
            # Create RDP file
            cat > win11.rdp << EOF
            full address:s:$FQDN
            username:s:${{ secrets.AZURE_ADMIN_USERNAME }}
            EOF
          else
            echo "âš ï¸  Could not retrieve FQDN. Check Azure Portal."
          fi

      - name: Upload RDP File
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: vm-connection
          path: win11.rdp
          retention-days: 7