name: Create WVM XI
on:
  workflow_dispatch:
    inputs:
      sourceRdpIP:
        description: 'Your Public IP'
        required: true
        default: '*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login
        run: |
          echo "ðŸ” Logging in with Service Principal..."
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}" \
            --output none
          
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          echo "âœ… Login successful"

      - name: Deploy VM
        run: |
          echo "ðŸš€ Deploying Windows 11 VM..."
          echo "========================================"
          echo "VM Name: ${{ secrets.AZURE_VM_NAME }}"
          echo "Location: ${{ secrets.AZURE_LOCATION }}"
          echo "Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
          echo "VNet: ${{ secrets.AZURE_VNET_NAME }} (in ${{ secrets.AZURE_VNET_RG }})"
          echo "========================================"
          
          # Set defaults for optional parameters
          DNS_NAME="${{ secrets.AZURE_DNS_NAME || secrets.AZURE_VM_NAME }}"
          VNET_NAME="${{ secrets.AZURE_VNET_NAME || 'vmmexwin-vnet' }}"
          VNET_RG="${{ secrets.AZURE_VNET_RG || 'AG_RG' }}"
          SUBNET_NAME="${{ secrets.AZURE_SUBNET_NAME || 'default' }}"
          
          # Deploy
          az deployment group create \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --template-file ./infra/win11-vm.bicep \
            --name "deploy-${{ github.run_id }}" \
            --parameters \
              vmName="${{ secrets.AZURE_VM_NAME }}" \
              location="${{ secrets.AZURE_LOCATION }}" \
              adminUsername="${{ secrets.AZURE_ADMIN_USERNAME }}" \
              adminPassword="${{ secrets.AZURE_ADMIN_PASSWORD }}" \
              dnsName="$DNS_NAME" \
              existingVnetName="$VNET_NAME" \
              existingVnetResourceGroup="$VNET_RG" \
              existingSubnetName="$SUBNET_NAME" \
              sourceRdpIP="${{ github.event.inputs.sourceRdpIP }}" \
              vmSize="Standard_D4s_v3"

      - name: Get Connection Details
        if: success()
        run: |
          echo "ðŸ”— Getting connection details..."
          
          FQDN=$(az network public-ip show \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}-pip" \
            --query dnsSettings.fqdn -o tsv 2>/dev/null || echo "")
          
          if [ -n "$FQDN" ]; then
            echo "âœ… Connect via: mstsc /v:$FQDN"
            echo "Username: ${{ secrets.AZURE_ADMIN_USERNAME }}"
            
            # Create RDP file
            cat > win11.rdp << EOF
            full address:s:$FQDN
            username:s:${{ secrets.AZURE_ADMIN_USERNAME }}
            EOF
          else
            echo "âš ï¸ Could not retrieve FQDN. Check Azure Portal."
          fi

      - name: Upload RDP File
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: vm-connection
          path: win11.rdp