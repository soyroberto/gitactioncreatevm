name: Create Windows 11 VM
on:
  workflow_dispatch:
    inputs:
      sourceRdpIP:
        description: 'Your Public IP (use * for testing only)'
        required: true
        default: '*'
      vmSize:
        description: 'VM Size'
        required: false
        default: 'Standard_D4s_v3'
      enableAutoShutdown:
        description: 'Enable auto-shutdown (saves cost)'
        type: boolean
        default: true
      shutdownTime:
        description: 'Auto-shutdown time (24h format)'
        required: false
        default: '20:00'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        run: |
          echo "Azure CLI version:"
          az version --output table

      - name: Azure Login with Service Principal
        run: |
          echo "ðŸ” Logging in with Service Principal..."
          echo "Client ID: ${{ secrets.AZURE_CLIENT_ID }}"
          echo "Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
          
          # Login with service principal
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}" \
            --output none
          
          # Set subscription
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          
          echo "âœ… Login successful!"
          az account show --query "{Subscription:name}" -o table

      - name: Validate Resource Group
        run: |
          echo "ðŸ” Validating resource group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
          
          if az group exists --name "${{ secrets.AZURE_RESOURCE_GROUP }}"; then
            echo "âœ… Resource group exists"
          else
            echo "ðŸ”„ Creating resource group..."
            az group create \
              --name "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --location "${{ secrets.AZURE_LOCATION }}" \
              --tags "CreatedBy=GitHubActions" "Environment=Production" \
                     "Repository=${{ github.repository }}" "RunID=${{ github.run_id }}"
            echo "âœ… Resource group created"
          fi

      - name: Validate VNet in Different RG
        run: |
          echo "ðŸ” Checking VNet exists in separate resource group..."
          echo "VNet Name: ${{ secrets.AZURE_VNET_NAME }}"
          echo "VNet RG: ${{ secrets.AZURE_VNET_RG }}"
          
          # Check if SP has permission on VNet RG
          echo "Checking permissions on VNet resource group..."
          
          # Verify VNet exists
          VNET_INFO=$(az network vnet show \
            --name "${{ secrets.AZURE_VNET_NAME }}" \
            --resource-group "${{ secrets.AZURE_VNET_RG }}" \
            --query "{Name:name, Location:location, Subnets:subnets[].name}" 2>/dev/null || echo "{}")
          
          if echo "$VNET_INFO" | grep -q "Name"; then
            echo "âœ… VNet exists in ${{ secrets.AZURE_VNET_RG }}"
            echo "$VNET_INFO" | jq .
          else
            echo "âŒ ERROR: VNet not found or no access"
            echo "Ensure:"
            echo "1. VNet '${{ secrets.AZURE_VNET_NAME }}' exists in RG '${{ secrets.AZURE_VNET_RG }}'"
            echo "2. SP has 'Reader' role on RG '${{ secrets.AZURE_VNET_RG }}'"
            echo ""
            echo "Run this command:"
            echo "az role assignment create \\"
            echo "  --assignee ${{ secrets.AZURE_CLIENT_ID }} \\"
            echo "  --role Reader \\"
            echo "  --resource-group ${{ secrets.AZURE_VNET_RG }}"
            exit 1
          fi

      - name: Deploy Windows 11 VM
        run: |
          echo "ðŸš€ Deploying Windows 11 VM..."
          echo "========================================"
          echo "VM Name: ${{ secrets.AZURE_VM_NAME }}"
          echo "Location: ${{ secrets.AZURE_LOCATION }}"
          echo "Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
          echo "DNS Name: ${{ secrets.AZURE_DNS_NAME }}"
          echo "VNet: ${{ secrets.AZURE_VNET_NAME }} (in RG: ${{ secrets.AZURE_VNET_RG }})"
          echo "Subnet: ${{ secrets.AZURE_SUBNET_NAME }}"
          echo "RDP Allowed from: ${{ github.event.inputs.sourceRdpIP }}"
          echo "========================================"
          
          # Create parameters JSON
          cat > /tmp/vm-params.json << EOF
          {
            "vmName": { "value": "${{ secrets.AZURE_VM_NAME }}" },
            "location": { "value": "${{ secrets.AZURE_LOCATION }}" },
            "adminUsername": { "value": "${{ secrets.AZURE_ADMIN_USERNAME }}" },
            "adminPassword": { "value": "${{ secrets.AZURE_ADMIN_PASSWORD }}" },
            "dnsName": { "value": "${{ secrets.AZURE_DNS_NAME }}" },
            "existingVnetName": { "value": "${{ secrets.AZURE_VNET_NAME }}" },
            "existingVnetResourceGroup": { "value": "${{ secrets.AZURE_VNET_RG }}" },
            "existingSubnetName": { "value": "${{ secrets.AZURE_SUBNET_NAME }}" },
            "sourceRdpIP": { "value": "${{ github.event.inputs.sourceRdpIP }}" },
            "vmSize": { "value": "${{ github.event.inputs.vmSize }}" }
          }
          EOF
          
          echo "ðŸ“‹ Deployment parameters:"
          cat /tmp/vm-params.json | jq .
          
          # Deploy the VM
          echo "ðŸ”„ Starting deployment (takes 5-10 minutes)..."
          az deployment group create \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --template-file ./infra/win11-vm.bicep \
            --parameters @/tmp/vm-params.json \
            --name "win11-vm-${{ github.run_id }}" \
            --no-wait
          
          echo "âœ… Deployment initiated. VM is provisioning..."

      - name: Wait for VM Provisioning
        run: |
          echo "â³ Waiting for VM to be ready..."
          echo "This can take 5-10 minutes. Please be patient."
          
          # Wait for deployment to complete
          az deployment group wait \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "win11-vm-${{ github.run_id }}" \
            --created \
            --timeout 900
          
          echo "âœ… VM deployment completed!"
          
          # Wait for VM to be running
          az vm wait \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}" \
            --created \
            --timeout 300
          
          echo "ðŸŽ‰ VM is ready!"

      - name: Configure Auto-Shutdown
        if: ${{ github.event.inputs.enableAutoShutdown == 'true' }}
        run: |
          echo "â° Configuring auto-shutdown at ${{ github.event.inputs.shutdownTime }}..."
          
          az vm auto-shutdown \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}" \
            --time "${{ github.event.inputs.shutdownTime }}" \
            --timezone "Central Standard Time (Mexico)" \
            --email "${{ github.actor }}@users.noreply.github.com" \
            --webhook "" || echo "Note: Auto-shutdown may already be configured"
          
          echo "âœ… Auto-shutdown configured"

      - name: Get Connection Details
        id: connection
        run: |
          echo "ðŸ”— Getting connection details..."
          
          # Try multiple times in case IP is still being assigned
          for i in {1..5}; do
            echo "Attempt $i/5 to get connection info..."
            
            FQDN=$(az network public-ip show \
              --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --name "${{ secrets.AZURE_VM_NAME }}-pip" \
              --query dnsSettings.fqdn -o tsv 2>/dev/null || echo "")
            
            PUBLIC_IP=$(az network public-ip show \
              --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --name "${{ secrets.AZURE_VM_NAME }}-pip" \
              --query ipAddress -o tsv 2>/dev/null || echo "")
            
            if [ -n "$FQDN" ] && [ -n "$PUBLIC_IP" ]; then
              break
            fi
            sleep 30
          done
          
          if [ -z "$FQDN" ]; then
            echo "âš ï¸ Could not retrieve FQDN. Check Azure Portal for connection details."
            FQDN="Not available yet - check Azure Portal"
          else
            echo "FQDN=$FQDN" >> $GITHUB_OUTPUT
            echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_OUTPUT
            
            echo "========================================"
            echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
            echo "========================================"
            echo "ðŸ“± CONNECTION DETAILS:"
            echo "â€¢ DNS: $FQDN"
            echo "â€¢ IP: $PUBLIC_IP"
            echo "â€¢ Username: ${{ secrets.AZURE_ADMIN_USERNAME }}"
            echo "â€¢ Password: [from GitHub Secrets]"
            echo ""
            echo "ðŸ”— RDP COMMAND:"
            echo "mstsc /v:$FQDN"
            echo ""
            echo "â° Auto-shutdown: ${{ github.event.inputs.enableAutoShutdown && github.event.inputs.shutdownTime || 'Disabled' }}"
            echo "========================================"
            
            # Create RDP file
            cat > win11-connection.rdp << EOF
            full address:s:$FQDN
            username:s:${{ secrets.AZURE_ADMIN_USERNAME }}
            screen mode id:i:2
            use multimon:i:0
            desktopwidth:i:1920
            desktopheight:i:1080
            session bpp:i:32
            winposstr:s:0,1,0,0,800,600
            compression:i:1
            keyboardhook:i:2
            audiocapturemode:i:0
            videoplaybackmode:i:1
            connection type:i:7
            networkautodetect:i:1
            bandwidthautodetect:i:1
            displayconnectionbar:i:1
            enableworkspacereconnect:i:0
            disable wallpaper:i:0
            allow font smoothing:i:1
            allow desktop composition:i:1
            disable full window drag:i:1
            disable menu anims:i:1
            disable themes:i:0
            disable cursor setting:i:0
            bitmapcachepersistenable:i:1
            EOF
            
            echo "âœ… RDP file created: win11-connection.rdp"
          fi

      - name: Upload Connection Files
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: vm-connection-files
          path: |
            win11-connection.rdp
          retention-days: 7

      - name: Create Summary Report
        if: always()
        run: |
          echo "## ðŸ–¥ï¸ Windows 11 VM Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VM Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Name:** ${{ secrets.AZURE_VM_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Location:** ${{ secrets.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin:** ${{ secrets.AZURE_ADMIN_USERNAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group:** ${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VNet:** ${{ secrets.AZURE_VNET_NAME }} (in ${{ secrets.AZURE_VNET_RG }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ] && [ -n "${{ steps.connection.outputs.FQDN }}" ]; then
            echo "**âœ… Connection Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- **DNS:** \`${{ steps.connection.outputs.FQDN }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **IP:** \`${{ steps.connection.outputs.PUBLIC_IP }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **RDP Command:** \`mstsc /v:${{ steps.connection.outputs.FQDN }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download the RDP file from **Artifacts** section." >> $GITHUB_STEP_SUMMARY
          else
            echo "**âš ï¸ Connection details not available yet**" >> $GITHUB_STEP_SUMMARY
            echo "Check Azure Portal for VM status." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security:**" >> $GITHUB_STEP_SUMMARY
          echo "- RDP allowed from: \`${{ github.event.inputs.sourceRdpIP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-shutdown: ${{ github.event.inputs.enableAutoShutdown && github.event.inputs.shutdownTime || 'Disabled' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Deployment ID: ${{ github.run_id }}*" >> $GITHUB_STEP_SUMMARY

    outputs:
      vm_fqdn: ${{ steps.connection.outputs.FQDN }}
      vm_ip: ${{ steps.connection.outputs.PUBLIC_IP }}