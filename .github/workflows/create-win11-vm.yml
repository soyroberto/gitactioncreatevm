name: Create Windows 11 VM
on:
  workflow_dispatch:
    inputs:
      sourceRdpIP:
        description: 'Your Public IP (get with: curl https://api.ipify.org)'
        required: true
        default: '1.145.222.180/32'
      vmSize:
        description: 'VM Size'
        required: false
        default: 'Standard_D4s_v3'
      enableAutoShutdown:
        description: 'Enable auto-shutdown'
        type: boolean
        default: true
      shutdownTime:
        description: 'Auto-shutdown time (24h format)'
        required: false
        default: '20:00'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login
        run: |
          echo "ðŸ” Logging in with Service Principal..."
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}" \
            --output none
          
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          echo "âœ… Login successful"
          az account show --query "{Subscription:name}" -o table

      - name: Wait for Permission Propagation
        run: |
          echo "â³ Waiting 15 seconds for permission propagation..."
          sleep 15

      - name: Quick VNet Check (Non-blocking)
        continue-on-error: true
        run: |
          echo "ðŸ” Quick VNet check..."
          VNET_NAME=$(az network vnet show \
            --name "${{ secrets.AZURE_VNET_NAME }}" \
            --resource-group "${{ secrets.AZURE_VNET_RG }}" \
            --query "name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$VNET_NAME" ]; then
            echo "âœ… VNet accessible: $VNET_NAME"
          else
            echo "âš ï¸ Cannot access VNet, but continuing anyway..."
          fi

      - name: Ensure Resource Group
        run: |
          echo "ðŸ“¦ Ensuring resource group exists..."
          if az group exists --name "${{ secrets.AZURE_RESOURCE_GROUP }}"; then
            echo "âœ… Resource group exists"
          else
            echo "Creating resource group..."
            az group create \
              --name "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --location "${{ secrets.AZURE_LOCATION }}" \
              --tags "CreatedBy=GitHub" "Repo=${{ github.repository }}" "RunID=${{ github.run_id }}"
          fi

      - name: Deploy Windows 11 VM
        run: |
          echo "ðŸš€ Deploying Windows 11 VM..."
          echo "========================================"
          echo "VM: ${{ secrets.AZURE_VM_NAME }}"
          echo "Location: ${{ secrets.AZURE_LOCATION }}"
          echo "RG: ${{ secrets.AZURE_RESOURCE_GROUP }}"
          echo "VNet: ${{ secrets.AZURE_VNET_NAME }} (in ${{ secrets.AZURE_VNET_RG }})"
          echo "Subnet: ${{ secrets.AZURE_SUBNET_NAME }}"
          echo "RDP from: ${{ github.event.inputs.sourceRdpIP }}"
          echo "========================================"
          
          # Deploy with Bicep
          az deployment group create \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --template-file ./infra/win11-vm.bicep \
            --name "win11-deploy-${{ github.run_number }}" \
            --parameters \
              vmName="${{ secrets.AZURE_VM_NAME }}" \
              location="${{ secrets.AZURE_LOCATION }}" \
              adminUsername="${{ secrets.AZURE_ADMIN_USERNAME }}" \
              adminPassword="${{ secrets.AZURE_ADMIN_PASSWORD }}" \
              dnsName="${{ secrets.AZURE_DNS_NAME }}" \
              existingVnetName="${{ secrets.AZURE_VNET_NAME }}" \
              existingVnetResourceGroup="${{ secrets.AZURE_VNET_RG }}" \
              existingSubnetName="${{ secrets.AZURE_SUBNET_NAME }}" \
              sourceRdpIP="${{ github.event.inputs.sourceRdpIP }}" \
              vmSize="${{ github.event.inputs.vmSize }}"

      - name: Wait for VM Provisioning
        run: |
          echo "â³ Waiting for VM to be ready (5-10 minutes)..."
          az vm wait \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}" \
            --created \
            --timeout 600
          echo "âœ… VM is ready!"

      - name: Configure Auto-Shutdown
        if: ${{ github.event.inputs.enableAutoShutdown == 'true' }}
        run: |
          echo "â° Setting auto-shutdown to ${{ github.event.inputs.shutdownTime }}..."
          az vm auto-shutdown \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}" \
            --time "${{ github.event.inputs.shutdownTime }}" \
            --timezone "Central Standard Time (Mexico)" \
            --email "${{ github.actor }}@users.noreply.github.com" \
            --webhook "" || echo "Auto-shutdown already configured"

      - name: Get Connection Details
        id: connection
        run: |
          echo "ðŸ”— Getting connection details..."
          
          # Try multiple times
          for i in {1..5}; do
            echo "Attempt $i/5..."
            
            FQDN=$(az network public-ip show \
              --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --name "${{ secrets.AZURE_VM_NAME }}-pip" \
              --query dnsSettings.fqdn -o tsv 2>/dev/null || echo "")
            
            if [ -n "$FQDN" ]; then
              break
            fi
            echo "Not ready yet, waiting 30 seconds..."
            sleep 30
          done
          
          if [ -z "$FQDN" ]; then
            echo "âŒ Could not retrieve FQDN"
            echo "Please check Azure Portal for connection details"
            exit 0  # Don't fail, just continue
          fi
          
          PUBLIC_IP=$(az network public-ip show \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_VM_NAME }}-pip" \
            --query ipAddress -o tsv)
          
          echo "FQDN=$FQDN" >> $GITHUB_OUTPUT
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_OUTPUT
          
          echo "========================================"
          echo "ðŸŽ‰ VM DEPLOYMENT COMPLETE!"
          echo "========================================"
          echo "Connect via RDP:"
          echo "mstsc /v:$FQDN"
          echo ""
          echo "Username: ${{ secrets.AZURE_ADMIN_USERNAME }}"
          echo "Password: [from GitHub Secrets]"
          echo "========================================"
          
          # Create RDP file
          cat > win11.rdp << EOF
          full address:s:$FQDN
          username:s:${{ secrets.AZURE_ADMIN_USERNAME }}
          screen mode id:i:2
          use multimon:i:0
          desktopwidth:i:1920
          desktopheight:i:1080
          session bpp:i:32
          winposstr:s:0,1,0,0,800,600
          compression:i:1
          keyboardhook:i:2
          audiocapturemode:i:0
          videoplaybackmode:i:1
          connection type:i:7
          networkautodetect:i:1
          bandwidthautodetect:i:1
          displayconnectionbar:i:1
          enableworkspacereconnect:i:0
          disable wallpaper:i:0
          allow font smoothing:i:1
          allow desktop composition:i:1
          disable full window drag:i:1
          disable menu anims:i:1
          disable themes:i:0
          disable cursor setting:i:0
          bitmapcachepersistenable:i:1
          EOF

      - name: Upload Connection Files
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: vm-connection
          path: win11.rdp
          retention-days: 7

      - name: Create Deployment Summary
        if: always()
        run: |
          echo "## ðŸ–¥ï¸ Windows 11 VM Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- **VM:** ${{ secrets.AZURE_VM_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Location:** ${{ secrets.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin:** ${{ secrets.AZURE_ADMIN_USERNAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **RG:** ${{ secrets.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VNet:** ${{ secrets.AZURE_VNET_NAME }} (in ${{ secrets.AZURE_VNET_RG }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Subnet:** ${{ secrets.AZURE_SUBNET_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **RDP Allowed from:** \`${{ github.event.inputs.sourceRdpIP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ] && [ -n "${{ steps.connection.outputs.FQDN }}" ]; then
            echo "**âœ… Connection Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- **DNS:** \`${{ steps.connection.outputs.FQDN }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **IP:** \`${{ steps.connection.outputs.PUBLIC_IP }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **RDP Command:** \`mstsc /v:${{ steps.connection.outputs.FQDN }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¥ Download RDP file from **Artifacts**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**â„¹ï¸ Check Azure Portal for connection details**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Deployment ID: ${{ github.run_id }}*" >> $GITHUB_STEP_SUMMARY

    outputs:
      vm_fqdn: ${{ steps.connection.outputs.FQDN }}
      vm_ip: ${{ steps.connection.outputs.PUBLIC_IP }}